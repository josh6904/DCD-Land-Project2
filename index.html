<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCD Possess The Land | Fundraising Dashboard</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #059669;       /* Emerald Green */
            --primary-dark: #064E3B;
            --primary-light: #D1FAE5;
            --secondary: #3B82F6;     /* Blue */
            --accent: #F59E0B;        /* Amber */
            --danger: #EF4444;        /* Red */
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --sidebar-bg: #111827;
            --text-main: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        aside {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 50; /* Lower than modals */
        }

        main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 32px; 
            scroll-behavior: smooth;
            position: relative;
            z-index: 1;
        }

        /* --- NAVIGATION --- */
        .brand { 
            font-size: 1.25rem; 
            font-weight: 800; 
            margin-bottom: 40px; 
            color: var(--primary); 
            line-height: 1.2;
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .nav-group { display: flex; flex-direction: column; gap: 4px; }
        
        .nav-item { 
            padding: 12px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: #9CA3AF; 
            transition: all 0.2s; 
            font-size: 0.95rem;
            position: relative;
            z-index: 10;
        }
        .nav-item:hover { background: #374151; color: white; }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; }

        /* --- TYPOGRAPHY & COMPONENTS --- */
        h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; color: #111827; }
        h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 16px; }
        h3 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; color: var(--text-main); }
        p { color: var(--text-light); font-size: 0.95rem; line-height: 1.5; }
        
        .card { 
            background: var(--surface); 
            padding: 24px; 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow-sm); 
            margin-bottom: 24px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

        /* Buttons */
        .btn {
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            justify-content: center;
            position: relative;
            z-index: 20; /* Ensure buttons are clickable */
        }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: #F9FAFB; border-color: #D1D5DB; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #DC2626; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-block { width: 100%; }

        /* Forms */
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            margin-bottom: 16px; 
            font-size: 0.95rem;
            background: #fff;
            transition: border 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        label { display: block; font-weight: 500; font-size: 0.85rem; margin-bottom: 6px; color: #374151; }

        /* Tables */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: #F9FAFB; color: var(--text-light); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        .money { font-family: 'Courier New', Courier, monospace; font-weight: 700; letter-spacing: -0.5px; }
        
        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .badge-success { background: var(--primary-light); color: var(--primary-dark); }
        .badge-warn { background: #FEF3C7; color: #92400E; }
        .badge-danger { background: #FEE2E2; color: var(--danger); }

        /* Progress Bars */
        .progress-wrapper { margin-bottom: 12px; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; font-weight: 500; }
        .progress-track { background: #E5E7EB; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-fill.warn { background: var(--accent); }
        .progress-fill.danger { background: var(--danger); }

        /* --- MODAL SYSTEM --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000; /* VERY HIGH Z-INDEX TO FIX CLICK ISSUES */
            backdrop-filter: blur(2px);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal { 
            background: white; 
            width: 90%; 
            max-width: 500px; 
            padding: 0; 
            border-radius: 16px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
            position: relative;
            z-index: 2001; /* Higher than overlay */
        }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal-lg { max-width: 800px; }

        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #F9FAFB; }
        .modal-header h3 { margin: 0; }
        .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 16px 24px; background: #F9FAFB; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); line-height: 1; }
        
        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2002; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: #1F2937; color: white; padding: 12px 20px; border-radius: 8px; 
            box-shadow: var(--shadow-md); font-size: 0.9rem; 
            transform: translateX(100%); transition: transform 0.3s ease;
            display: flex; align-items: center; gap: 10px; pointer-events: auto;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--primary); }
        .toast.error { border-left: 4px solid var(--danger); }

        /* Helpers */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-right { text-align: right; }
        .w-full { width: 100%; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.8rem; }

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { 
                width: 100%; 
                height: auto; 
                flex-direction: row; 
                padding: 12px 20px; 
                justify-content: space-between; 
                position: fixed; 
                bottom: 0; 
                top: auto; 
                border-top: 1px solid var(--border); 
                background: white; 
                color: var(--text-main);
                box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
                z-index: 1000; /* Mobile nav highest */
            }
            .brand { display: none; }
            .nav-group { flex-direction: row; justify-content: space-between; width: 100%; }
            .nav-item { flex-direction: column; gap: 4px; padding: 8px; font-size: 0.7rem; text-align: center; }
            main { padding-bottom: 90px; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <span>üèùÔ∏è</span>
            <div>
                <div>DCD</div>
                <div style="font-size: 0.8rem; font-weight: 500; color: #9CA3AF; letter-spacing: 1px;">POSSESS THE LAND</div>
            </div>
        </div>
        <nav class="nav-group">
            <div class="nav-item active" onclick="app.router('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="app.router('pledges')">ü§ù Pledges</div>
            <div class="nav-item" onclick="app.router('ledger')">üí∞ Ledger</div>
            <div class="nav-item" onclick="app.router('tribes')">üèÜ Tribes</div>
            <div class="nav-item" onclick="app.router('settings')">‚öôÔ∏è Settings</div>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-container">
        
        <!-- DASHBOARD -->
        <section id="view-dashboard">
            <div class="flex-between" style="margin-bottom: 24px;">
                <div>
                    <h1>Project Overview</h1>
                    <p>Fundraising status for <strong>DCD Possess The Land</strong></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="app.openModal('manual-cash')">üíµ Manual Cash</button>
                    <button class="btn btn-primary" onclick="app.openModal('sms-parse')">‚ö° SMS Parser</button>
                    <button class="btn btn-primary" style="background: var(--secondary);" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>

            <!-- KPI CARDS -->
            <div class="grid-4">
                <div class="card">
                    <p class="text-light">Total Cash Collected</p>
                    <h2 class="text-success" style="color: var(--primary); font-size: 2rem;" id="dash-cash">KES 0</h2>
                </div>
                <div class="card">
                    <p class="text-light">Total Pledges</p>
                    <h2 style="color: var(--secondary); font-size: 2rem;" id="dash-pledges">KES 0</h2>
                </div>
                <div class="card">
                    <p class="text-light">Redemption Rate</p>
                    <h2 id="dash-rate">0%</h2>
                </div>
                <div class="card">
                    <p class="text-light">Total Donors</p>
                    <h2 id="dash-donors">0</h2>
                </div>
            </div>

            <div class="grid-2">
                <!-- PHASE PROGRESS -->
                <div class="card">
                    <div class="flex-between">
                        <h3>Collection Phases</h3>
                        <button class="btn btn-sm btn-secondary" onclick="app.router('settings')">Edit</button>
                    </div>
                    <div id="phase-list" style="margin-top: 16px;">
                        <!-- JS Injected -->
                    </div>
                </div>

                <!-- RECENT ACTIVITY -->
                <div class="card">
                    <h3>Recent Transactions</h3>
                    <div id="recent-activity" style="margin-top: 16px; display: flex; flex-direction: column; gap: 12px;">
                        <p class="text-light" style="text-align: center; padding: 20px;">No recent activity.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PLEDGES VIEW -->
        <section id="view-pledges" class="hidden">
            <div class="flex-between" style="margin-bottom: 24px;">
                <h1>Member Pledges</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="app.exportCSV('pledges')">üì• Export</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>
            
            <div class="card">
                <div style="margin-bottom: 16px;">
                    <input type="text" id="pledge-search" placeholder="Search by name..." onkeyup="app.renderPledges()">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Member Name</th>
                                <th>Department</th>
                                <th class="text-right">Pledged</th>
                                <th class="text-right">Paid</th>
                                <th class="text-right">Balance</th>
                                <th class="text-right">Status</th>
                            </tr>
                        </thead>
                        <tbody id="pledges-table-body">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- LEDGER VIEW -->
        <section id="view-ledger" class="hidden">
            <div class="flex-between" style="margin-bottom: 24px;">
                <h1>Transaction Ledger</h1>
                <button class="btn btn-secondary" onclick="app.exportCSV('ledger')">üì• Export Audit</button>
            </div>

            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Name/Description</th>
                                <th>Type</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-table-body">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TRIBES VIEW -->
        <section id="view-tribes" class="hidden">
            <h1>Department Performance</h1>
            <div id="tribes-container" class="grid-2" style="margin-top: 24px;">
                <!-- JS Injected -->
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="hidden">
            <h1>Admin Settings</h1>
            
            <div class="card">
                <h3>Manage Collection Phases</h3>
                <p class="text-light" style="margin-bottom: 16px;">Set deadlines and specific targets for each department.</p>
                
                <!-- FIX: onsubmit is now INLINE in HTML to ensure it always works -->
                <form id="phase-form" onsubmit="app.addPhaseFromForm(event)">
                    <div class="grid-2">
                        <div>
                            <label>Phase Name</label>
                            <input type="text" id="phase-name" required placeholder="e.g. March Offering">
                        </div>
                        <div>
                            <label>Target Date</label>
                            <input type="date" id="phase-date" required>
                        </div>
                    </div>
                    
                    <div style="background: #F9FAFB; padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                        <h4 style="margin-bottom: 12px; font-size: 0.9rem; color: var(--text-main);">Department Targets</h4>
                        <div id="dept-targets-container" class="grid-2" style="gap: 12px;">
                            <!-- JS will populate inputs here -->
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E5E7EB; font-weight: 600; font-size: 0.9rem; text-align: right;">
                            Total Project Target: <span id="total-target-preview">KES 0</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top: 16px;">Create Phase</button>
                </form>

                <div style="margin-top: 32px;">
                    <h4>Existing Phases</h4>
                    <div id="settings-phase-list" style="margin-top: 12px;"></div>
                </div>
            </div>

            <div class="card" style="border-color: var(--danger);">
                <h3 style="color: var(--danger);">Danger Zone</h3>
                <p class="text-light">Permanently delete all application data. This cannot be undone.</p>
                <button class="btn btn-danger" style="margin-top: 12px;" onclick="app.hardReset()">Reset All Data</button>
            </div>
        </section>

    </main>

    <!-- === MODALS === -->

    <!-- 1. PLEDGE MODAL -->
    <div class="modal-overlay" id="modal-pledge">
        <div class="modal">
            <div class="modal-header">
                <h3>New Pledge</h3>
                <button class="close-modal" onclick="app.closeModal('pledge')">&times;</button>
            </div>
            <form onsubmit="app.submitPledge(event)">
                <div class="modal-body">
                    <label>Member Name</label>
                    <input type="text" name="name" required placeholder="e.g. John Doe">
                    
                    <label>Department</label>
                    <select name="department" id="modal-dept-select" required>
                        <!-- Populated by JS -->
                    </select>
                    
                    <label>Pledge Amount (KES)</label>
                    <input type="number" name="amount" required min="1" placeholder="0.00">
                    
                    <small style="color: var(--accent); display:block; margin-top:10px;">
                        ‚ÑπÔ∏è <strong>Note:</strong> If this specific Name + Department combination already exists, amount will be added to their existing pledge.
                    </small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('pledge')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Pledge</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. SMS PARSER MODAL -->
    <div class="modal-overlay" id="modal-sms-parse">
        <div class="modal modal-lg" style="max-width: 600px;">
            <div class="modal-header">
                <h3>‚ö° M-Pesa SMS Parser</h3>
                <button class="close-modal" onclick="app.closeModal('sms-parse')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-light">Paste SMS confirmation messages below.</p>
                <textarea id="sms-input" style="width: 100%; height: 150px; font-family: monospace; font-size: 0.85rem;" placeholder="Paste here... e.g. 'Confirmed. You have received Ksh 5,000 from JOHN DOE...'"></textarea>
                
                <div id="staged-area" class="hidden" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 16px;">
                    <div class="flex-between" style="margin-bottom: 12px;">
                        <strong>Found Transactions (<span id="staged-count">0</span>)</strong>
                        <small class="text-light">Review before committing</small>
                    </div>
                    <div id="staged-list" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                        <!-- Staged Items go here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal('sms-parse')">Close</button>
                <button type="button" class="btn btn-primary" id="btn-parse-trigger" onclick="app.processSMS()">‚ö° Extract Data</button>
                <button type="button" class="btn btn-primary hidden" id="btn-commit-trigger" onclick="app.commitStaged()">Commit All</button>
            </div>
        </div>
    </div>

    <!-- 3. MANUAL CASH MODAL -->
    <div class="modal-overlay" id="modal-manual-cash">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Manual Cash</h3>
                <button class="close-modal" onclick="app.closeModal('manual-cash')">&times;</button>
            </div>
            <form onsubmit="app.submitManualCash(event)">
                <div class="modal-body">
                    <label>Payer Name</label>
                    <input type="text" id="cash-name" list="member-list" required placeholder="Name">
                    <datalist id="member-list"></datalist>

                    <label>Department</label>
                    <select id="cash-dept" required>
                        <!-- JS Populated -->
                    </select>

                    <label>Amount (KES)</label>
                    <input type="number" id="cash-amount" required min="1">
                    
                    <label>Reference/Note</label>
                    <input type="text" id="cash-ref" placeholder="e.g. Offering Envelope #1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('manual-cash')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS ---
        const DEPARTMENTS = [
            "Eagles", "Daughters of Faith", "Youth", 
            "Kingdom Generation", "Planning Committee", "Guests"
        ];
        const DB_KEY = 'dcd_possess_land_v12'; // Final Version

        // --- STORE ---
        const store = {
            data: {
                pledges: [], // { id, name, department, amount, date }
                transactions: [], // { id, pledgeId, amount, type, ref, date, method, department }
                phases: [] // { id, name, target, date, deptTargets: {Eagles: 1000, ...} }
            },

            init() {
                const saved = localStorage.getItem(DB_KEY);
                if (saved) {
                    this.data = JSON.parse(saved);
                } else {
                    // Seed Initial Data
                    this.data.phases.push({
                        id: Date.now(),
                        name: "Initial Phase",
                        totalTarget: 1000000,
                        date: new Date().toISOString().split('T')[0],
                        deptTargets: {} 
                    });
                    this.save();
                }
            },

            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(this.data));
                app.render();
            },

            addPledge(name, dept, amount) {
                const existing = this.data.pledges.find(p => 
                    p.name.toLowerCase() === name.toLowerCase() &&
                    p.department.toLowerCase() === dept.toLowerCase()
                );
                
                if (existing) {
                    existing.amount += parseFloat(amount);
                    this.save();
                    app.showToast(`Updated pledge for ${name} (${dept})`, 'success');
                    return existing.id;
                } else {
                    const id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                    this.data.pledges.push({
                        id,
                        name,
                        department: dept,
                        amount: parseFloat(amount),
                        date: new Date().toISOString()
                    });
                    this.save();
                    return id;
                }
            },

            addTransaction(tx) {
                // Explicitly handle date string vs object
                const timestamp = (typeof tx.date === 'string') ? new Date(tx.date) : (tx.date instanceof Date) ? tx.date : new Date();

                this.data.transactions.unshift({
                    id: Date.now().toString(),
                    ...tx,
                    date: timestamp.toISOString()
                });
                this.save();
            },

            addPhase(name, date, deptTargets) {
                const total = Object.values(deptTargets).reduce((a,b) => a+b, 0);
                this.data.phases.push({
                    id: Date.now(),
                    name, 
                    totalTarget: total, 
                    date,
                    deptTargets
                });
                this.data.phases.sort((a,b) => new Date(a.date) - new Date(b.date));
                this.save();
            },

            deletePhase(id) {
                this.data.phases = this.data.phases.filter(p => p.id !== id);
                this.save();
            },

            reset() {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        };

        // --- APP CONTROLLER ---
        // Changed from window.app to const app for stability
        const app = {
            stagedTx: [],

            init() {
                this.populateDeptSelects();
                this.renderSettingsForm();
                this.render();
            },

            router(viewId) {
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const map = { 'dashboard':0, 'pledges':1, 'ledger':2, 'tribes':3, 'settings':4 };
                const navItems = document.querySelectorAll('.nav-item');
                if(navItems[map[viewId]]) {
                    navItems[map[viewId]].classList.add('active');
                }
            },

            openModal(type) {
                document.getElementById(`modal-${type}`).classList.add('open');
            },
            closeModal(type) {
                document.getElementById(`modal-${type}`).classList.remove('open');
                if(type === 'sms-parse') {
                    document.getElementById('sms-input').value = '';
                    document.getElementById('staged-area').classList.add('hidden');
                    document.getElementById('btn-parse-trigger').classList.remove('hidden');
                    document.getElementById('btn-commit-trigger').classList.add('hidden');
                    document.getElementById('btn-parse-trigger').innerText = "‚ö° Extract Data";
                    this.stagedTx = [];
                }
            },

            populateDeptSelects() {
                const opts = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
                const modalDept = document.getElementById('modal-dept-select');
                if(modalDept) modalDept.innerHTML = opts;
                
                const cashDept = document.getElementById('cash-dept');
                if(cashDept) cashDept.innerHTML = opts;
                
                const names = [...new Set(store.data.pledges.map(p => p.name))];
                const memberList = document.getElementById('member-list');
                if(memberList) memberList.innerHTML = names.map(n => `<option value="${n}">`).join('');
            },

            renderSettingsForm() {
                const container = document.getElementById('dept-targets-container');
                if(container) {
                    container.innerHTML = '';
                    
                    DEPARTMENTS.forEach(dept => {
                        const div = document.createElement('div');
                        div.className = 'input-group';
                        div.innerHTML = `
                            <label>${dept} Target</label>
                            <input type="number" id="targ-${dept.replace(/\s/g, '')}" class="dept-target-input" placeholder="0" min="0" oninput="app.updateTotalPreview()">
                        `;
                        container.appendChild(div);
                    });
                }
            },

            updateTotalPreview() {
                let total = 0;
                document.querySelectorAll('.dept-target-input').forEach(inp => {
                    total += Number(inp.value) || 0;
                });
                const preview = document.getElementById('total-target-preview');
                if(preview) preview.innerText = app.formatMoney(total);
            },

            addPhaseFromForm(e) {
                e.preventDefault();
                const name = document.getElementById('phase-name').value;
                const date = document.getElementById('phase-date').value;
                
                const targets = {};
                DEPARTMENTS.forEach(dept => {
                    const val = document.getElementById(`targ-${dept.replace(/\s/g, '')}`).value;
                    targets[dept] = Number(val) || 0;
                });

                store.addPhase(name, date, targets);
                this.showToast('Phase created', 'success');
                document.getElementById('phase-form').reset();
                this.updateTotalPreview();
            },

            submitPledge(e) {
                e.preventDefault();
                const form = e.target;
                store.addPledge(form.name.value, form.department.value, form.amount.value);
                this.closeModal('pledge');
                form.reset();
            },

            submitManualCash(e) {
                e.preventDefault();
                const name = document.getElementById('cash-name').value;
                const dept = document.getElementById('cash-dept').value;
                const amount = parseFloat(document.getElementById('cash-amount').value);
                const ref = document.getElementById('cash-ref').value || 'Manual Cash';
                const timestamp = new Date(); // Use CURRENT time for manual cash

                // 1. Check Duplicate
                const dupe = this.checkDuplicate(name, dept, amount, timestamp);

                if (dupe) {
                    this.showToast(`Duplicate: Same amount from ${name} (${dept}) within 30 minutes.`, 'error');
                    return;
                }

                // 2. Find or Create Pledge
                let pledge = store.data.pledges.find(p => 
                    p.name.toLowerCase() === name.toLowerCase() &&
                    p.department.toLowerCase() === dept.toLowerCase()
                );
                
                if (!pledge) {
                    const pid = store.addPledge(name, dept, amount);
                    pledge = store.data.pledges.find(p => p.id === pid);
                }

                // 3. Add Transaction
                store.addTransaction({
                    pledgeId: pledge.id,
                    name: pledge.name,
                    department: dept,
                    amount: amount,
                    type: 'credit',
                    method: 'Cash',
                    ref: ref,
                    date: timestamp.toISOString() // Pass explicit date for Cash too
                });

                this.closeModal('manual-cash');
                this.showToast('Payment recorded!', 'success');
                e.target.reset();
            },

            hardReset() {
                if(confirm("Are you absolutely sure? This deletes all data.")) {
                    store.reset();
                }
            },

            // --- DUPLICATE CHECKER ---
            checkDuplicate(name, dept, amount, dateObj) {
                const THIRTY_MINS = 30 * 60 * 1000;
                const checkTime = dateObj.getTime();

                return store.data.transactions.some(t => {
                    const isSamePerson = t.name.toLowerCase() === name.toLowerCase() && 
                                         t.department.toLowerCase() === dept.toLowerCase();
                    const isSameAmount = Math.abs(t.amount - amount) < 0.01;
                    const txTime = new Date(t.date).getTime();
                    const isRecent = Math.abs(txTime - checkTime) < THIRTY_MINS;

                    return isSamePerson && isSameAmount && isRecent;
                });
            },

            // --- SMS PARSER LOGIC (ROBUST & DEBUG) ---
            processSMS() {
                const btn = document.getElementById('btn-parse-trigger');
                btn.innerText = "Analyzing...";
                
                try {
                    const text = document.getElementById('sms-input').value;
                    if(!text.trim()) {
                        alert("Please paste text first.");
                        btn.innerText = "‚ö° Extract Data";
                        return;
                    }

                    const lines = text.split('\n');
                    const results = [];

                    console.log("Lines to process:", lines.length);

                    lines.forEach((line, index) => {
                        try {
                            // 1. Find Amount (Universal Check)
                            const amtMatch = line.match(/Ksh\s*([\d,]+\.?\d*)/i);
                            
                            if(!amtMatch) return;
                            
                            const amount = parseFloat(amtMatch[1].replace(/,/g, ''));
                            console.log(`  Line ${index}: Amount found`, amount);

                            // 2. Determine Type
                            const isPersonal = line.toLowerCase().includes('received');
                            const isTill = line.toLowerCase().includes('sent to');
                            
                            if (isPersonal) {
                                // Split by 'from'
                                const parts = line.split(/from\s+/i);
                                if(parts.length < 2) return;
                                
                                const rest = parts[1];
                                const onIndex = rest.indexOf(' on ');
                                
                                if(onIndex === -1) return;
                                
                                let rawName = rest.substring(0, onIndex).trim();
                                // Remove trailing numbers
                                rawName = rawName.replace(/\s+\d{10,}$/, '');

                                const dateStr = rest.substring(onIndex + 4); // Skip ' on '
                                
                                const dateObj = this.parseSimpleMpesaDate(dateStr);

                                if(dateObj) {
                                    results.push({
                                            amount,
                                            name: rawName,
                                            method: 'M-Pesa',
                                            ref: 'SMS-' + Math.floor(Math.random()*10000),
                                            date: dateObj
                                        });
                                    console.log(`  -> Parsed Successfully`);
                                }
                            } else if (isTill) {
                                const tillMatch = line.match(/sent to\s+([A-Z0-9\s]+?)\s+for account/i);
                                if(tillMatch) {
                                     const onIndex = line.indexOf(' on ');
                                     const dateStr = onIndex > -1 ? line.substring(onIndex + 4) : '';
                                     const dateObj = dateStr ? this.parseSimpleMpesaDate(dateStr) : new Date();

                                     results.push({
                                            amount,
                                            name: tillMatch[1].trim(),
                                            method: 'Till/Paybill',
                                            ref: 'TILL-' + Math.floor(Math.random()*10000),
                                            date: dateObj
                                        });
                                     console.log(`  -> Parsed Successfully`);
                                }
                            }
                        } catch(lineError) {
                            console.error("Error processing line", lineError);
                        }
                    });

                    console.log("Total Parsed:", results.length);

                    if (results.length === 0) {
                        alert("No valid M-Pesa messages found in text.");
                        btn.innerText = "‚ö° Extract Data";
                        return;
                    }

                    this.stagedTx = results;
                    this.renderStaged();
                    
                    document.getElementById('staged-area').classList.remove('hidden');
                    document.getElementById('btn-parse-trigger').classList.add('hidden');
                    document.getElementById('btn-commit-trigger').classList.remove('hidden');
                    
                    btn.innerText = "‚ö° Extract Data";

                } catch(err) {
                    console.error("Parser Crash:", err);
                    alert("Critical Error: " + err.message);
                    btn.innerText = "‚ö° Extract Data";
                }
            },

            parseSimpleMpesaDate(str) {
                if(!str) return null;
                const parts = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s+at\s+(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if(!parts) return null;

                const day = parseInt(parts[1]);
                const month = parseInt(parts[2]) - 1;
                let year = parseInt(parts[3]);
                if(year < 100) year += 2000;

                let hours = parseInt(parts[4]);
                const mins = parseInt(parts[5]);
                
                if (parts[6].toUpperCase() === 'PM' && hours !== 12) hours += 12;
                if (parts[6].toUpperCase() === 'AM' && hours === 12) hours = 0;

                return new Date(year, month, day, hours, mins);
            },

            renderStaged() {
                const list = document.getElementById('staged-list');
                document.getElementById('staged-count').innerText = this.stagedTx.length;
                list.innerHTML = '';

                this.stagedTx.forEach((tx, idx) => {
                    const existing = store.data.pledges.find(p => p.name.toLowerCase() === tx.name.toLowerCase());
                    
                    let deptSelect = '';
                    if (existing) {
                        deptSelect = `<span class="badge badge-success">${existing.department}</span>`;
                        tx.assignedDept = existing.department;
                    } else {
                        const options = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
                        deptSelect = `
                            <select onchange="app.stagedTx[${idx}].assignedDept = this.value" style="padding:4px; margin:0; font-size:0.8rem;">
                                <option value="">Select Dept...</option>
                                ${options}
                            </select>
                        `;
                    }

                    list.innerHTML += `
                        <div class="card" style="padding: 12px; margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:700;">${tx.name}</div>
                                <div style="font-size:0.85rem; color:var(--text-light);">${tx.method} ‚Ä¢ ${this.formatDate(tx.date)}</div>
                            </div>
                            <div class="text-right">
                                <div style="font-weight:700; color:var(--primary);">${this.formatMoney(tx.amount)}</div>
                                <div style="margin-top:4px;">${deptSelect}</div>
                            </div>
                        </div>
                    `;
                });
            },

            commitStaged() {
                let count = 0;
                this.stagedTx.forEach(tx => {
                    if(!tx.assignedDept) {
                        this.showToast(`Skipped ${tx.name}: No Department selected`, 'error');
                        return;
                    }

                    // 1. DUPLICATE CHECK
                    const dupe = this.checkDuplicate(tx.name, tx.assignedDept, tx.amount, tx.date);
                    
                    if (dupe) {
                        this.showToast(`Duplicate Skipped: ${tx.name} (${tx.assignedDept})`, 'error');
                        return;
                    }

                    // 2. Find or Create Pledge
                    let pledge = store.data.pledges.find(p => 
                        p.name.toLowerCase() === tx.name.toLowerCase() &&
                        p.department.toLowerCase() === tx.assignedDept.toLowerCase()
                    );
                    
                    if(!pledge) {
                        const pid = store.addPledge(tx.name, tx.assignedDept, tx.amount);
                        pledge = store.data.pledges.find(p => p.id === pid);
                    }

                    // 3. Add Transaction
                    // Note: Passing ISO string via .toISOString() on the Date object
                    store.addTransaction({
                        pledgeId: pledge.id,
                        name: pledge.name,
                        department: tx.assignedDept,
                        amount: tx.amount,
                        type: 'credit',
                        method: tx.method,
                        ref: tx.ref,
                        date: tx.date.toISOString() 
                    });
                    count++;
                });

                if(count > 0) {
                    this.showToast(`Successfully committed ${count} transactions!`, 'success');
                    this.closeModal('sms-parse');
                } else {
                    this.showToast('No transactions committed.', 'error');
                }
            },

            // --- RENDER FUNCTIONS ---
            render() {
                try {
                    this.renderDashboard();
                    this.renderPledges();
                    this.renderLedger();
                    this.renderTribes();
                    this.renderSettingsList();
                    this.populateDeptSelects();
                } catch(e) {
                    console.error("Render Error:", e);
                }
            },

            renderDashboard() {
                const totalCash = store.data.transactions.reduce((sum, t) => sum + t.amount, 0);
                const totalPledges = store.data.pledges.reduce((sum, p) => sum + p.amount, 0);
                const rate = totalPledges ? Math.round((totalCash / totalPledges) * 100) : 0;
                const uniqueDonors = new Set(store.data.transactions.map(t => t.pledgeId)).size;

                document.getElementById('dash-cash').innerText = this.formatMoney(totalCash);
                document.getElementById('dash-pledges').innerText = this.formatMoney(totalPledges);
                document.getElementById('dash-rate').innerText = rate + '%';
                document.getElementById('dash-donors').innerText = uniqueDonors;

                const phaseContainer = document.getElementById('phase-list');
                phaseContainer.innerHTML = '';
                
                store.data.phases.forEach(phase => {
                    const pct = Math.min(100, Math.round((totalCash / phase.totalTarget) * 100));
                    phaseContainer.innerHTML += `
                        <div class="progress-wrapper">
                            <div class="progress-info">
                                <span>${phase.name} <small style="font-weight:400; color:#666;">(${this.formatDate(phase.date)})</small></span>
                                <span>${pct}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill ${pct < 50 ? 'warn' : ''}" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                });

                const recent = document.getElementById('recent-activity');
                const txs = store.data.transactions.slice(0, 5);
                if(txs.length === 0) {
                    recent.innerHTML = '<p class="text-light" style="text-align:center;">No recent activity.</p>';
                } else {
                    recent.innerHTML = txs.map(t => `
                        <div class="flex-between" style="padding-bottom:8px; border-bottom:1px solid #eee;">
                            <div>
                                <div style="font-weight:600;">${t.name}</div>
                                <small class="text-light">${t.method} ‚Ä¢ ${this.formatDateTime(t.date)}</small>
                            </div>
                            <div style="font-weight:700; color:var(--primary);">+${this.formatMoney(t.amount)}</div>
                        </div>
                    `).join('');
                }
            },

            renderPledges() {
                const tbody = document.getElementById('pledges-table-body');
                const search = document.getElementById('pledge-search').value.toLowerCase();
                
                let html = '';
                store.data.pledges.forEach(p => {
                    if(p.name.toLowerCase().includes(search)) {
                        const paid = store.data.transactions
                            .filter(t => t.pledgeId === p.id)
                            .reduce((sum, t) => sum + t.amount, 0);
                        
                        const balance = p.amount - paid;
                        const status = balance <= 0 
                            ? '<span class="badge badge-success">Completed</span>' 
                            : '<span class="badge badge-warn">Active</span>';

                        html += `
                            <tr>
                                <td><strong>${p.name}</strong></td>
                                <td>${p.department}</td>
                                <td class="text-right">${this.formatMoney(p.amount)}</td>
                                <td class="text-right">${this.formatMoney(paid)}</td>
                                <td class="text-right" style="color:${balance > 0 ? 'var(--danger)' : 'var(--text-light)'}">${this.formatMoney(balance)}</td>
                                <td class="text-right">${status}</td>
                            </tr>
                        `;
                    }
                });
                tbody.innerHTML = html;
            },

            renderLedger() {
                const tbody = document.getElementById('ledger-table-body');
                if(store.data.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No transactions found.</td></tr>';
                    return;
                }

                // Sort by date descending (newest first)
                const sortedTx = [...store.data.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                tbody.innerHTML = sortedTx.map(t => `
                    <tr>
                        <td style="font-size:0.85rem; color:var(--text-light);">${this.formatDateTime(t.date)}</td>
                        <td style="font-family:monospace;">${t.ref}</td>
                        <td>${t.name}</td>
                        <td><span class="badge badge-success">${t.method}</span></td>
                        <td class="text-right">${this.formatMoney(t.amount)}</td>
                    </tr>
                `).join('');
            },

            renderTribes() {
                const container = document.getElementById('tribes-container');
                
                const activePhase = store.data.phases[store.data.phases.length - 1];
                
                const deptStats = DEPARTMENTS.map(dept => {
                    const deptPledges = store.data.pledges.filter(p => p.department === dept);
                    const target = deptPledges.reduce((sum, p) => sum + p.amount, 0);
                    
                    const pIds = deptPledges.map(p => p.id);
                    const collected = store.data.transactions
                        .filter(t => pIds.includes(t.pledgeId))
                        .reduce((sum, t) => sum + t.amount, 0);

                    const phaseTarget = (activePhase && activePhase.deptTargets && activePhase.deptTargets[dept]) 
                        ? activePhase.deptTargets[dept] 
                        : target;

                    const pct = phaseTarget ? Math.round((collected / phaseTarget) * 100) : 0;

                    return { dept, target, collected, pct, phaseTarget };
                }).sort((a,b) => b.collected - a.collected);

                container.innerHTML = deptStats.map((d, i) => `
                    <div class="card">
                        <div class="flex-between" style="margin-bottom:12px;">
                            <h3>#${i+1} ${d.dept}</h3>
                            <span style="font-weight:700; color:var(--primary);">${d.pct}%</span>
                        </div>
                        <div class="progress-track" style="margin-bottom:12px;">
                            <div class="progress-fill" style="width: ${d.pct}%"></div>
                        </div>
                        <div class="flex-between" style="font-size:0.9rem;">
                            <span class="text-light">Collected</span>
                            <strong>${this.formatMoney(d.collected)}</strong>
                        </div>
                        <div class="flex-between" style="font-size:0.9rem;">
                            <span class="text-light">Phase Target</span>
                            <strong>${this.formatMoney(d.phaseTarget)}</strong>
                        </div>
                        ${d.phaseTarget !== d.target ? `
                        <div class="flex-between" style="font-size:0.85rem; margin-top:4px; color:#9CA3AF;">
                            <span>(Pledged: ${this.formatMoney(d.target)})</span>
                        </div>` : ''}
                    </div>
                `).join('');
            },

            renderSettingsList() {
                const list = document.getElementById('settings-phase-list');
                list.innerHTML = store.data.phases.map(p => `
                    <div class="flex-between" style="padding: 12px; background: #f9fafb; margin-bottom: 8px; border-radius: 6px;">
                        <div>
                            <strong>${p.name}</strong>
                            <div class="text-light" style="font-size:0.8rem;">Target: ${this.formatMoney(p.totalTarget)} ‚Ä¢ ${this.formatDate(p.date)}</div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="store.deletePhase(${p.id})">Delete</button>
                    </div>
                `).join('');
            },

            // --- UTILS ---
            formatMoney(amount) {
                return 'KES ' + amount.toLocaleString('en-KE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            },

            formatDate(isoStr) {
                return new Date(isoStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            },

            formatDateTime(isoStr) {
                const d = new Date(isoStr);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) + 
                       ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            },

            showToast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = type === 'success' ? '‚úÖ ' + msg : '‚ö†Ô∏è ' + msg;
                container.appendChild(toast);

                void toast.offsetWidth;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },

            exportCSV(type) {
                let csv = [];
                if(type === 'pledges') {
                    csv.push(['Name', 'Department', 'Pledged', 'Paid', 'Balance']);
                    store.data.pledges.forEach(p => {
                        const paid = store.data.transactions.filter(t => t.pledgeId === p.id).reduce((s,t)=>s+t.amount,0);
                        csv.push([`"${p.name}"`, p.department, p.amount, paid, p.amount-paid]);
                    });
                } else {
                    csv.push(['Date', 'Reference', 'Name', 'Method', 'Amount']);
                    store.data.transactions.forEach(t => {
                        csv.push([t.date, t.ref, `"${t.name}"`, t.method, t.amount]);
                    });
                }

                const csvContent = "data:text/csv;charset=utf-8," + csv.map(e => e.join(",")).join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `DCD_${type}_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
            }
        };

        // Start App
        // Use direct call instead of listener to guarantee execution
        app.init();

    </script>
</body>
</html>
